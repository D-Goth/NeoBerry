<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NeoBerry GPIO Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #121212; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1, h2 { text-align: center; margin-bottom: 20px; }

        .led {
            width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin: 0 5px; border: 1px solid #fff;
        }
        .led-on { background-color: #28a745; }
        .led-off { background-color: #dc3545; }
        .led-blink { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .gpio-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .gpio-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .gpio-item { display: flex; align-items: center; margin: 5px; }
        .info-btn { margin-left: 5px; cursor: pointer; }

        .rpi-image { text-align: center; margin-bottom: 20px; }
        .rpi-image img { max-width: 500px; height: auto; }

        .meter-container h2 { margin-top: 0; }
        .meter-table { width: 100%; border-collapse: separate; border-spacing: 10px; }
        .meter-frame {
            border: 2px solid #2c2c2c; border-radius: 5px; padding: 10px; text-align: center; min-height: 150px; position: relative; background-color: #2c2c2c;
        }
        .meter {
            height: 100px; width: 40px; margin: 0 auto; background-color: #444; position: relative; display: inline-block;
        }
        .meter .fill {
            width: 100%; position: absolute; bottom: 0; background: linear-gradient(to top, #28a745 0%, #dc3545 100%);
            transition: height 0.5s ease-in-out;
        }
        .meter .value { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 14px; color: #fff; }

        .bandwidth-container h2 { margin-top: 20px; }
        .bandwidth-table { width: 100%; border-collapse: separate; border-spacing: 10px; }
        .bandwidth-frame {
            border: 2px solid #2c2c2c; border-radius: 5px; padding: 10px; text-align: center; min-height: 150px; position: relative; background-color: #2c2c2c;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .bandwidth {
            width: 200px; height: 20px; margin: 0 auto; background-color: #444; position: relative; display: block;
        }
        .bandwidth .fill {
            height: 100%; position: absolute; left: 0; background: linear-gradient(to right, #28a745 0%, #dc3545 100%);
            transition: width 0.5s ease-in-out;
        }
        .bandwidth .value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; color: #fff; }

        .button-container { text-align: center; margin-top: 20px; }
        .button-container img { width: 50px; height: 50px; margin: 0 10px; cursor: pointer; }

        @media (max-width: 768px) {
            .gpio-row { flex-direction: column; align-items: center; }
            .meter { height: 80px; width: 30px; }
            .bandwidth { width: 150px; height: 15px; }
            .meter-frame, .bandwidth-frame { min-height: 120px; }
            .meter .value, .bandwidth .value { font-size: 12px; }
            .button-container img { width: 40px; height: 40px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>NeoBerry GPIO Control</h1>

    <div class="gpio-container">
        <div class="gpio-row">
            {% for pin in range(1, 21) %}
                {% set state = pins.get(pin, False) %}
                {% set active = activity.get(pin, False) and state %}
                <div class="gpio-item">
                    <span>{{ pin }}</span>
                    <span class="led {{ 'led-on led-blink' if active else 'led-on' if state else 'led-off' }}"></span>
                    <div class="form-check form-switch">
                        <input class="form-check-input toggle-switch" type="checkbox" role="switch" id="switch-{{ pin }}" data-pin="{{ pin }}" {{ 'checked' if state else '' }}>
                    </div>
                    <span class="info-btn" onclick="editInfo({{ pin }})" data-bs-toggle="tooltip" data-bs-placement="top" title="Cliquez pour éditer l'info de la pin {{ pin }}">?</span>
                </div>
            {% endfor %}
        </div>
        <div class="gpio-row">
            {% for pin in range(21, 41) %}
                {% set state = pins.get(pin, False) %}
                {% set active = activity.get(pin, False) and state %}
                <div class="gpio-item">
                    <span>{{ pin }}</span>
                    <span class="led {{ 'led-on led-blink' if active else 'led-on' if state else 'led-off' }}"></span>
                    <div class="form-check form-switch">
                        <input class="form-check-input toggle-switch" type="checkbox" role="switch" id="switch-{{ pin }}" data-pin="{{ pin }}" {{ 'checked' if state else '' }}>
                    </div>
                    <span class="info-btn" onclick="editInfo({{ pin }})" data-bs-toggle="tooltip" data-bs-placement="top" title="Cliquez pour éditer l'info de la pin {{ pin }}">?</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="rpi-image">
        <img src="https://www.raspberrypi-spy.co.uk/wp-content/uploads/2012/06/Raspberry-Pi-GPIO-Header-with-Photo-768x512.png" alt="Raspberry Pi 5 Schematic">
    </div>

    <div class="meter-container">
        <h2>System</h2>
        <table class="meter-table">
            <tbody id="meters-body">
                <tr>
                    <td><div class="meter-frame"><div class="meter" data-label="cpu"><div class="fill" id="cpu-meter-fill"></div><div class="value" id="cpu">{{ metrics.cpu_usage or 'N/A' }}%</div></div><div class="label">CPU Usage</div></div></td>
                    <td><div class="meter-frame"><div class="meter" data-label="ram"><div class="fill" id="ram-meter-fill"></div><div class="value" id="ram">{{ metrics.ram_usage or 'N/A' }}%</div></div><div class="label">Memory Usage</div></div></td>
                    <td><div class="meter-frame"><div class="meter" data-label="board-temp"><div class="fill" id="board-temp-meter-fill"></div><div class="value" id="board-temp">{{ metrics.board_temp or 'N/A' }}°C</div></div><div class="label">Board Temp</div></div></td>
                    <td><div class="meter-frame"><div class="meter" data-label="cpu-temp"><div class="fill" id="cpu-temp-meter-fill"></div><div class="value" id="cpu-temp">{{ metrics.cpu_temp or 'N/A' }}°C</div></div><div class="label">CPU Temp</div></div></td>
                    <td><div class="meter-frame"><div class="meter" data-label="fan-speed"><div class="fill" id="fan-speed-meter-fill"></div><div class="value" id="fan-speed">{{ metrics.fan_speed or 'N/A' }} RPM</div></div><div class="label">Fan Speed</div></div></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bandwidth-container">
        <h2>Network</h2>
        <table class="bandwidth-table">
            <tbody id="bandwidth-body">
                <tr>
                    <td><div class="bandwidth-frame"><div class="bandwidth" data-label="up"><div class="fill" id="network-up-fill"></div><div class="value" id="network-up">{{ metrics.network_up or 'N/A' }}</div></div><div class="label">Upload</div></div></td>
                    <td><div class="bandwidth-frame"><div class="bandwidth" data-label="down"><div class="fill" id="network-down-fill"></div><div class="value" id="network-down">{{ metrics.network_down or 'N/A' }}</div></div><div class="label">Download</div></div></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: center; padding-top: 10px;">
                        <select id="refresh-interval" onchange="updateRefreshInterval()">
                            <option value="0">Temps réel</option>
                            <option value="250">0.25s</option>
                            <option value="500">0.5s</option>
                            <option value="1000" selected>1s</option>
                            <option value="2000">2s</option>
                            <option value="5000">5s</option>
                            <option value="10000">10s</option>
                            <option value="30000">30s</option>
                            <option value="60000">60s</option>
                        </select>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="button-container">
        <a href="https://github.com/D-Goth/NeoBerry" target="_blank"><img src="img/github.png" alt="GitHub"></a>
        <img src="img/reboot.gif" alt="Reboot" onclick="rebootPi()">
        <img src="img/shutdown.gif" alt="Shutdown" onclick="shutdownPi()">
        <a href="https://www.Black-Lab.Fr" target="_blank"><img src="img/website.png" alt="Website"></a>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Initialiser les tooltips Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        $('.toggle-switch').on('change', function () {
            const pin = $(this).data('pin');
            const state = $(this).is(':checked');
            $.ajax({
                url: `/toggle/${pin}`,
                method: 'POST',
                data: { state: state },
                success: updateStatus,
                error: function () {
                    alert('Erreur lors du basculement de la broche ' + pin);
                    $(`#switch-${pin}`).prop('checked', !state);
                }
            });
        });

        function editInfo(pin) {
            let currentInfo = getCookie(`pin_${pin}_info`) || `Info sur la pin ${pin}`;
            let newInfo = prompt('Entrez une description pour la pin ' + pin, currentInfo);
            if (newInfo) {
                setCookie(`pin_${pin}_info`, newInfo, 365);
                $(`[data-pin="${pin}"] + .info-btn`).attr('title', newInfo).tooltip('dispose').tooltip('show');
            }
        }

        let refreshInterval = 2000; // Défaut : 2s
        function updateRefreshInterval() {
            const interval = parseInt($('#refresh-interval').val());
            refreshInterval = interval === 0 ? 100 : interval; // "Temps réel" ≈ 100ms
            clearInterval(updateStatusInterval);
            updateStatusInterval = setInterval(updateStatus, refreshInterval);
        }

        let updateStatusInterval = setInterval(updateStatus, refreshInterval);

        function updateStatus() {
            $.getJSON('/status', function (data) {
                const pins = data.pins;
                const metrics = data.metrics;

                // Mettre à jour les mètres principaux
                updateMeter('cpu-meter-fill', Math.min(100, metrics.cpu_usage || 0), '#cpu');
                updateMeter('ram-meter-fill', Math.min(100, metrics.ram_usage || 0), '#ram');
                updateMeter('board-temp-meter-fill', Math.min(100, (metrics.board_temp || 0) / 85 * 100), '#board-temp');
                updateMeter('cpu-temp-meter-fill', Math.min(100, (metrics.cpu_temp || 0) / 85 * 100), '#cpu-temp');
                updateMeter('fan-speed-meter-fill', Math.min(100, (metrics.fan_speed || 0) / 1000 * 100), '#fan-speed');

                // Mettre à jour les bandes passantes
                updateBandwidth('network-up-fill', metrics.network_up || 'N/A', '#network-up');
                updateBandwidth('network-down-fill', metrics.network_down || 'N/A', '#network-down');

                // Ajouter/Mettre à jour les mètres des disques
                if (metrics.disks) {
                    $('#meters-body tr').each(function() {
                        const $row = $(this);
                        const labels = $row.find('.meter').map(function() { return $(this).data('label'); }).get();
                        for (let label of labels) {
                            if (!['cpu', 'ram', 'board-temp', 'cpu-temp', 'fan-speed'].includes(label) && !metrics.disks[label]) {
                                $row.find(`[data-label="${label}"]`).closest('td').remove();
                            }
                        }
                    });
                    for (let disk in metrics.disks) {
                        let $td = $(`#${disk}-meter-fill`).closest('td');
                        if (!$td.length) {
                            $td = $('<td></td>');
                            $td.append(`<div class="meter-frame"><div class="meter" data-label="${disk}"><div class="fill" id="${disk}-meter-fill"></div><div class="value" id="${disk}">${metrics.disks[disk].usage || 'N/A'}% (Temp: ${metrics.disks[disk].temp || 'N/A'}°C)</div></div><div class="label">${disk} Usage</div></div>`);
                            $('#meters-body tr').append($td);
                        }
                        updateMeter(`${disk}-meter-fill`, Math.min(100, metrics.disks[disk].usage || 0), `#${disk}`);
                        $(`#${disk}`).text(`${metrics.disks[disk].usage || 'N/A'}% (Temp: ${metrics.disks[disk].temp || 'N/A'}°C)`);
                    }
                }
            });
        }

        function updateMeter(id, percent, textId) {
            const $fill = $('#' + id);
            $fill.css('height', `${percent}%`);
            const unit = textId.includes('temp') ? '°C' : textId.includes('speed') ? ' RPM' : '%';
            $(textId).text(`${percent || 0}${unit}`);
        }

        function updateBandwidth(id, value, textId) {
            const $fill = $('#' + id);
            if (value !== 'N/A') {
                // Convertir la vitesse en octets par seconde pour calculer le pourcentage
                const bytes_per_sec = parseValueToBytes(value);
                const max_bandwidth = 100 * 1024 * 1024; // 100 MB/s comme max
                const percent = Math.min(100, (bytes_per_sec / max_bandwidth) * 100);
                $fill.css('width', `${percent}%`);
            } else {
                $fill.css('width', '0%');
            }
            $(textId).text(value);
        }

        function parseValueToBytes(value) {
            const match = value.match(/(\d+\.?\d*)\s*(B|KB|MB|GB)\/s/);
            if (!match) return 0;
            const num = parseFloat(match[1]);
            const unit = match[2];
            const units = { 'B': 1, 'KB': 1024, 'MB': 1024 * 1024, 'GB': 1024 * 1024 * 1024 };
            return num * units[unit];
        }

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function rebootPi() {
            if (confirm('Voulez-vous redémarrer la Raspberry Pi ?')) {
                $.get('/reboot');
            }
        }

        function shutdownPi() {
            if (confirm('Voulez-vous éteindre la Raspberry Pi ?')) {
                $.get('/shutdown');
            }
        }
    </script>
</body>
</html>
