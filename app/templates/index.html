<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NeoBerry GPIO Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background-color: #121212; color: #fff; }

        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
            border: 1px solid #fff;
        }
        .led-on { background-color: #28a745; }
        .led-off { background-color: #dc3545; }
        .led-blink { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .gauge {
            width: 100px;
            height: 100px;
            position: relative;
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .gauge .background {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #333;
            position: absolute;
            top: 0;
            left: 0;
        }
        .gauge .donut {
            width: 80%;
            height: 80%;
            position: absolute;
            top: 10%;
            left: 10%;
            border-radius: 50%;
            background-color: #121212;
        }
        .gauge .fill {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            clip-path: circle(50% at 50% 50%);
            transform-origin: center;
            transition: background 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .gauge .value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #fff;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">NeoBerry GPIO Control</h1>

    <div class="mb-4">
        <div class="d-flex justify-content-between mb-2 flex-wrap">
            {% for pin in range(2, 16) %}
                {% set state = pins.get(pin, False) %}
                {% set active = activity.get(pin, False) and state %}
                <div class="d-flex flex-column align-items-center mx-2">
                    <span class="led {{ 'led-on led-blink' if active else 'led-on' if state else 'led-off' }}"></span>
                    <span>{{ pin }}</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input toggle-switch" type="checkbox" role="switch" id="switch-{{ pin }}" data-pin="{{ pin }}" {{ 'checked' if state else '' }}>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="d-flex justify-content-between flex-wrap">
            {% for pin in range(16, 28) %}
                {% set state = pins.get(pin, False) %}
                {% set active = activity.get(pin, False) and state %}
                <div class="d-flex flex-column align-items-center mx-2">
                    <span class="led {{ 'led-on led-blink' if active else 'led-on' if state else 'led-off' }}"></span>
                    <span>{{ pin }}</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input toggle-switch" type="checkbox" role="switch" id="switch-{{ pin }}" data-pin="{{ pin }}" {{ 'checked' if state else '' }}>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="mb-4">
        <canvas id="gpioChart" style="max-height: 300px;"></canvas>
    </div>

    <div class="text-center mb-4">
        {% set labels = ['cpu', 'ram', 'board-temp', 'cpu-temp', 'fan-speed'] %}
        {% for label in labels %}
        <div class="gauge">
            <div class="background"></div>
            <div class="donut"></div>
            <div class="fill" id="{{ label }}-gauge-fill"></div>
            <div class="value" id="{{ label }}">{{ metrics[label.replace('-', '_')] or 'N/A' }}{% if 'temp' in label %}°C{% elif label == 'fan-speed' %} RPM{% else %}%{% endif %}</div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    const ctx = document.getElementById('gpioChart').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for pin in pins.keys() %} '{{ pin }}',{% endfor %}],
            datasets: [{
                label: 'GPIO State',
                data: [{% for state in pins.values() %} {{ 1 if state else 0 }},{% endfor %}],
                backgroundColor: [{% for state in pins.values() %} '{{ '#28a745' if state else '#dc3545' }}',{% endfor %}],
                borderColor: [{% for state in pins.values() %} '{{ '#28a745' if state else '#dc3545' }}',{% endfor %}],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'GPIO States (HIGH=1, LOW=0)', color: '#ffffff' }
            },
            scales: {
                x: {
                    title: { display: true, text: 'GPIO Pin', color: '#ffffff' },
                    ticks: { color: '#ffffff' }
                },
                y: {
                    title: { display: true, text: 'State', color: '#ffffff' },
                    ticks: { color: '#ffffff' },
                    min: 0,
                    max: 1
                }
            }
        }
    });

    $(document).ready(function () {
        $('.toggle-switch').on('change', function () {
            const pin = $(this).data('pin');
            const state = $(this).is(':checked');
            $.ajax({
                url: `/toggle/${pin}`,
                method: 'POST',
                data: { state: state },
                success: updateStatus,
                error: function () {
                    alert('Erreur lors du basculement de la broche ' + pin);
                    $(`#switch-${pin}`).prop('checked', !state);
                }
            });
        });

        function updateStatus() {
            $.getJSON('/status', function (data) {
                const pins = data.pins;
                chart.data.datasets[0].data = Object.values(pins).map(v => v ? 1 : 0);
                chart.data.datasets[0].backgroundColor = Object.values(pins).map(v => v ? '#28a745' : '#dc3545');
                chart.data.datasets[0].borderColor = chart.data.datasets[0].backgroundColor;
                chart.update();

                const metrics = data.metrics;
                updateGauge('cpu-gauge-fill', metrics.cpu_usage || 0, '#cpu-usage');
                updateGauge('ram-gauge-fill', metrics.ram_usage || 0, '#ram-usage');
                updateGauge('board-temp-gauge-fill', (metrics.board_temp || 0) / 85 * 100, '#board-temp');
                updateGauge('cpu-temp-gauge-fill', (metrics.cpu_temp || 0) / 85 * 100, '#cpu-temp');
                updateGauge('fan-speed-gauge-fill', (metrics.fan_speed || 0) / 6000 * 100, '#fan-speed');

                $('#cpu-usage').text(`${metrics.cpu_usage || 0}%`);
                $('#ram-usage').text(`${metrics.ram_usage || 0}%`);
                $('#board-temp').text(`${metrics.board_temp || 0}°C`);
                $('#cpu-temp').text(`${metrics.cpu_temp || 0}°C`);
                $('#fan-speed').text(`${metrics.fan_speed || 0} RPM`);
            });
        }

        function updateGauge(id, percent, textId) {
            const angle = (percent / 100) * 270 - 135;
            const fill = document.getElementById(id);
            fill.style.transform = `rotate(${angle}deg)`;

            let color = '#28a745';
            if (percent >= 75) color = '#dc3545';
            else if (percent >= 50) color = '#ffc107';

            fill.style.background = color;
        }

        setInterval(updateStatus, 2000);
    });
</script>
</body>
</html>
